.page-header
  %h1.title
    = @subject.name
    = context_icon(@subject)

= render_wiki(@subject.text)


= content_for(:sidebar) do
  -# Use @attachments, which is restricted by dm only / veil passes
  - @attachments.each do |attachment|
    - if attachment == @subject.attachments.first
      %h4
        %i.icon-paper-clip
        Attachments
    = link_to(attachment.attachment.url) do
      - if attachment.image? # TODO set default url
        = attachment_image_overlay(attachment) do
          = image_tag(attachment.attachment.thumb.url, :class => "img-polaroid")
      %span<>
        = File.basename(attachment.attachment.path, File.extname(attachment.attachment.path)).humanize
    - unless attachment.image?
      = context_icon(attachment)
    = attachment_metadata(attachment)

    - unless attachment == @subject.attachments.last
      %div{style: "margin-top: 4px"} Â 

  %h4
    %i.icon-time
    Changes
  .row
    .span1 Updated:
    .span2{title: @subject.updated_at.year}
      = @subject.updated_at.to_s(:short)
  .row
    .span1 Created:
    .span2{title: @subject.created_at.year}
      = @subject.created_at.to_s(:short)

- if @subject.veil_passes.present? && can?(:read, VeilPass)
  = content_for(:sidebar) do
    %h4
      %i.icon-key
      Veil Passes
    %ul
      = list_of(@subject.veil_passes.joins(:user).order(:users => [:first_name, :last_name])) do |vp|
        = vp.user_name
        - if vp.includes_attachments
          %abbr{rel: "tooltip", title: "This veil pass includes attachments."}
            %i.icon-paper-clip

- if can?(:update, Subject) || can?(:destroy, Subject)
  = content_for(:sidebar) do
    %h4
      %i.icon-wrench
      Actions
    %ul.inline
      - if can?(:update, Subject)
        %li
          = link_to(edit_subject_path(@subject), accesskey: "e") do
            %i.icon-pencil
            Edit
      - if can?(:destroy, Subject)
        %li
          = link_to(subject_path(@subject),
                    :method => :delete,
                    :class => "action-danger",
                    :confirm => "Are you sure?") do
            %i.icon-remove
            Delete
